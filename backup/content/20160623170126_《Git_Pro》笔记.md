Title: 《Git Pro》笔记
Date: 2016-06-23 17:01:26
Category: 技术
Tags: 笔记, Git
Slug: 《Git_Pro》笔记
Author: Lemon Tree

### 2.2 Git 基础 - 记录每次更新到仓库
![文件的状态变化周期][1]

+ gitignore的规范
    + 空行或#开头的行被忽略
    + 最后跟/表示要忽略的目录
    + 取反在开头加！
    + 与shell的匹配模式相同
        + `*`：零个或多个任意字符
        + ` [abc]`：a或b或c
        + `?`：一个任意字符
        + ` [0-9]`：0~9
+ `git diff`：修改后未暂存起来的变化
+ `git diff --cached`：已暂存未提交的变化
+ `git commit -a`：所有跟踪的文件都提交
+ `git rm --cached`：不再追踪文件
+ `git rm \*~`：删除当前及**子目录**下以*~*结尾的文件，加"\"是为了不然shell进行转义

### 2.3 Git 基础 - 查看提交历史

+ `git log -p -2`：`-p`显示内容差异，`-2`显示最近两次
+ `git log -U1 --word-diff`：`-U1`指定上下文为1行，`--word-diff`指定单词层面的对比
+ `git log --stat`：显示增改行数统计
+ `git log --pretty=short|full|fuller|oneline`：指定显示格式
+ `git log --pretty=format:"%h - %an, %ar : %s"`：format指定显示的内容
    + `%H`：提交对象（commit）的完整哈希字串
    + `%h`：提交对象的简短哈希字串
    + `%T`：树对象（tree）的完整哈希字串
    + `%t`：树对象的简短哈希字串
    + `%P`：父对象（parent）的完整哈希字串
    + `%p`：父对象的简短哈希字串
    + `%an`：作者（author）的名字
    + `%ae`：作者的电子邮件地址
    + `%ad`：作者修订日期（可以用 -date= 选项定制格式）
    + `%ar`：作者修订日期，按多久以前的方式显示
    + `%cn`：提交者(committer)的名字
    + `%ce`：提交者的电子邮件地址
    + `%cd`：提交日期
    + `%cr`：提交日期，按多久以前的方式显示
    + `%s`：提交说明
+ `git log --pretty=format:"%h %s" --graph`：`--graph`SCII 字符串表示的简单图形
+ 常用选项
    + `-(n)`    仅显示最近的 n 条提交
    + `--since, --after`    仅显示指定时间之后的提交。
    + `--until, --before`    仅显示指定时间之前的提交。
    + `--author`    仅显示指定作者相关的提交。
    + `--committer`    仅显示指定提交者相关的提交。
    + `--name-only`    仅在提交信息后显示已修改的文件清单。
    + `--name-status`    显示新增、修改、删除的文件清单。
    + `--abbrev-commit`    仅显示 SHA-1 的前几个字符，而非所有的 40 个字符。
    + `--relative-date`    使用较短的相对时间显示（比如，“2 weeks ago”）。
    + `--oneline`   ` --pretty=oneline --abbrev-commit` 的简化用法。

### 2.4 Git 基础 - 撤消操作

+ `git commit --amend`：修改最后一次提交

### 2.5 Git 基础 - 远程仓库的使用

+ `git remote -v`：显示远程仓库的地址
+ `git remote add [shortname] [url]`：添加一个远程仓库，名字为*shortname*，地址为*url*
+ `git fetch [remote-name]`：从远程仓库*remote-name*中拉取数据到本地，**并不进行合并**
+ `git push origin master`：推送本地的*master*分支到远程仓库*origin*
+ `git remote show [remote-name]`：显示远程仓库*remote-name*的详细信息
+ `git remote rename [old-name] [new-name]`：重命名远程仓库在本地的简称
+ `git remote rm [shortname]`：删除远程仓库

### 2.6 Git 基础 - 打标签

+ `git tag -l [pattern]`：搜索tag，显示匹配*pattern*的tag
+ `git tag -a [tag-name] -m string obj`：创建一个附注标签，并添加说明，若`-a`改为`-s`，则表示用GPG来签署标签(`-a`:*annotated* `-s`:*signed* `-v`:*verify*)
+ `git push origin [tagname]`或`git push origin --tags`：推送标签到远程仓库

### 2.7 Git 基础 - 技巧和窍门

+ `git config --global alias.co checkout`：别名，`git co`==`git checkout`
+ `git config --global alias.visual '!gitk'`：别名，`git visual`启动外部命令gitk

### 3.1 Git 分支 - 何谓分支
![单个提交对象在仓库中的数据结构][2]
![多个提交对象之间的链接关系][3]
### 3.2 Git 分支 - 分支的新建与合并

`git checkout -b iss53`==`git branch iss53`+`git checkout iss53`
`git branch -d [branch-name]`：删除分支
`git merge [branch-name]`：合并当前分支和*branch-name*指定的分支

### 3.3 Git 分支 - 分支的管理

`git branch -v`：查看各个分支最后一次提交的信息
`git branch --merged|no-merged`：查看哪些分支已经合并/未合并到当前分支(当前分支的直接上游)
`git branch -D`：强制删除未合并的分支(可能会丢失数据)

### 3.5 Git 分支 - 远程分支

+ `git push origin serverfix:awesomebranch`：推送本地的*serverfix*分支到远程仓库*origin*，并命名为*awesomebranch*
+ `git checkout -b serverfix origin/serverfix`：*origin/serverfix*是远程仓库*origin*的分支*serverfix*在本地的克隆，这条语句是新建并转到一个分支，该分支以*origin/serverfix*为基础
+ `git checkout --track origin/serverfix`：新建同名分支，来追踪远程分支*origin/serverfix*
+ `git push origin :serverfix`：删除远程分支(推送本地的空分支到远程的*serverfix*分支，即删除)

### 3.6 Git 分支 - 分支的衍合

+ rebase的概念：在一个分支上从某处开始的变化(补丁)在另一个分支上重现一遍(重新打一遍补丁)
+ `git rebase --onto master server client`：取出*client*分支，找出*client*分支和*server*分支的共同祖先之后的变化，然后把它们在*master*上重演一遍
之前：
![从一个特性分支里再分出一个特性分支的历史][4]
之后：
![将特性分支上的另一个特性分支衍合到其他分支][5]
+ `git rebase master server`：把*server*分支rebase到*master*
之前：
![快进 master 分支，使之包含 client 分支的变化][6]
之后：
![在 master 分支上衍合 server 分支][7]
+ **一旦分支中的提交对象发布到公共仓库，就千万不要对该分支进行衍合操作。**

### 4.1 服务器上的 Git - 协议

+ 本地协议：

`git clone file:///path/project.git`
`git clone /path/project.git`

+ ssh 协议：

`git clone ssh://user@server/path/project.git`
`git clone user@server:/path/project.git`

+ git协议：

缺少授权机制，所有人的权限相同，可以所有人都有clone权限，也可以所有人都有推送权限
`git clone git://url/project.git`

+ http/s协议：

`git clone http://url/project.git`

### 5.1 分布式Git-分布式工作流程

+ 集中式工作流
![集中式工作流][8]
+ 集成管理员工作流
![集成管理员工作流][9]
+ 司令官与副官工作流
![司令官与副官工作流][10]

### 5.2 分布式Git-为项目做贡献

`git diff --check`:检查多余的空白字符

> 本次更新的简要描述（50 个字符以内）
>
> 如果必要，此处展开详尽阐述。段落宽度限定在 72 个字符以内。
> 某些情况下，第一行的简要描述将用作邮件标题，其余部分作为邮件正文。
> 其间的空行是必要的，以区分两者（当然没有正文另当别论）。
> 如果并在一起，rebase 这样的工具就可能会迷惑。
>
> 另起空行后，再进一步补充其他说明。
>
>  - 可以使用这样的条目列举式。
>
>  - 一般以单个空格紧跟短划线或者星号作为每项条目的起始符。每个条目间用一空行隔开。
>   不过这里按自己项目的约定，可以略作变化。
![多用户共享仓库协作方式的一般工作流程时序][11]
![团队间协作工作流程基本时序][12]


### 5.3 分布式 Git - 项目的管理
+ 分支中可以有命名空间，比如`sc/ruby_client`
+ 两种补丁方式：
    + diff工具：`git apply patch`、`git apply --check patch`。事务性操作，要么全部打上要么全部放弃不会存在补丁打一半的情况
    + format-patch：`git am patch`、`git am -3 patch`
+ `git log a -not master`：查看a分支上但不在master分支上的提交
+ `git diff master...a`：*master*到分支*a*的差别
+ `git cherry-pick e43a6fd3e94888d76`：提取某次提交的补丁，应用在当前分支上
+ `git describe master`：生成git版本号
+ 压缩：
```sh
git archive master --prefix='project/' | gzip > `git describe master`.tar.gz
git archive master --prefix='project/' --format=zip > `git describe master`.zip
```
+ `git shortlog --no-merges master --not v1.0.1`：生成修改日志，自从v1.0.1版本以来的所有提交的简介

### 6.1 Git 工具 - 修订版本（Revision）选择
+ `git reflog`：引用日志，只在本地有效，从仓库被clone时开始记录
+ `git show HEAD@{5}`：查看仓库中* HEAD *在五次前的值
+ `git show master@{yesterday}`：查看master分支昨天的情况
+ 提交范围
    + 双点
        + `git log master..experiment`：所有可从*experiment*分支中获得而不能从*master*分支中获得的提交
        + `git log origin/master..HEAD`：显示任何在当前分支上而不在远程*origin*上的提交
    + 多点
        + `git log refA refB ^refC`、`git log refA refB --not refC`：查找所有从*refA*或*refB*包含的但是不被*refC*包含的提交
    + 三点
        + `git log master...experiment`：查看*master*或者*experiment*中包含的但不是两者共有的引用
        + `git log --left-right master...experiment`：显示每个提交到底处于哪一侧的分支

### 6.3 Git 工具 - 储藏（Stashing）
+ `git stash list`：查看现有的储藏
+ `git stash apply stash@{2}`：应用储藏，如果不指定名字，默认使用最近的储藏
+ `git stash drop`：删除某次储藏
+ `git stash show -p stash@{0} | git apply -R`：取消之前所应用储藏的修改
+ `git stash branch testchanges`：从储藏中创建一个新的分支*testchanges*，并删除储藏

### 6.4 Git 工具 - 重写历史
+ `git commit --amend`：修改上一次的提交，会修改SHA-1的值，不要在推送到远程仓库后使用
+ `git rebase -i HEAD~3`：修改最近3次的提交，修改pick为edit，修改完成后`git rebase --continue`
+ `git filter-branch --tree-filter 'rm -f passwords.txt' HEAD`：在所有提交中删除文件*passwords.txt*，`--tree-filter`会在每次检出项目时先执行指定的命令然后重新提交结果

### 6.5 Git 工具 - 使用 Git 调试
+ `git blame -C -L 12,22 simplegit.rb`：查看文件*simplegit.rb*中第12到22行的修改日志，`-C`显示代码的原始出处
+ 二分查找：
```sh
git bisect start
git bisect bad
git bisect good v1.0
...
git bisect reset
```
或者有脚本在正常时返回0，错误时返回非0的话，可以完全自动地执行git bisect
```sh
git bisect start HEAD v1.0
git bisect run test-error.sh
```

### 6.6 Git 工具 - 子模块
+ `git submodule add url`：添加子模块
+ `git submodule init`、`git submodule update`：拉取、更新子模块
+ 归并的只是子模块的指针，并不更新子模块里的代码，需要手动拉取子模块的代码。如果开发者仅在本地更新了子模块，未上传公共仓库，会造成其他开发者子模块的指针指向最新但无法拉去最新代码的情况
+ 将子目录改为子模块，需要先撤回子目录不被git追踪，然后再追加为子模块

### 6.7 Git 工具 - 子树合并
+ 归并策略：2个分支--递归策略，超过两个分支--章鱼策略。处理子项目--子树归并策略
+ 用子树归并处理子目录问题：
```sh
$ git remote add rack_remote git@github.com:schacon/rack.git
$ git fetch rack_remote
$ git checkout -b rack_branch rack_remote/master
$ git checkout master
$ git read-tree --prefix=rack/ -u rack_branch
```

    当上游项目更新后，切换到rack_branch分支后pull后再归并
```sh
$ git checkout master
$ git merge --squash -s subtree --no-commit rack_branch
```
    获取*rack_branch*和和*rack*目录的区别，或者比较*rack*子目录和服务器上拉取时*master*分支的差别
```sh
$ git diff-tree -p rack_branch
$ git diff-tree -p rack_remote/master
```

### 7.1 自定义 Git - 配置 Git
+ git配置文件的优先级：*./git/config*>*~/.gitconfig*>*/etc/gitconfig*
+ `git config --global ***` --> *~/.gitconfig*，`git config --system ***` --> */etc/gitconfig*
+ 客户端基本配置
    + `core.editor`：文本编辑器
    + `commit.template`：提交时的模版文件
    + `core.pager`：分页器，默认为less
    + `core.excludesfile`：类似*.gitignore*，不过在项目外不被git追踪
    + `help.autocorrect`：自动校正
    + `color.ui`：颜色
    + `merge.tool`：合并工具
    + `core.autocrlf`：行结束符CRLF转换成LF

### 7.2 自定义 Git - Git属性
+ 属性文件：*.gitattributes*或*.git/info/attributes*
+ 追踪doc文档：
    1. 在*.gitattributes*文件中追加`*.doc diff=word`
    2. `git config diff.word .textconv catdoc`
+ 追踪图像文件：
    1. 在*.gitattributes*文件中追加`*.png diff=exif`
    2. `git config diff.exif.textconv exiftool`
+ 目录被追踪，但是用`git archive`创建压缩包时不包含该目录，在*.gitattributes*中追加`test/ export-ignore`
+ 合并策略，合并分支时忽略某些文件：在*.gitattributes*中追加`database.xml merge=ours`


  [1]: http://git-scm.com/figures/18333fig0201-tn.png
  [2]: http://git-scm.com/figures/18333fig0301-tn.png
  [3]: http://git-scm.com/figures/18333fig0302-tn.png
  [4]: http://git-scm.com/figures/18333fig0331-tn.png
  [5]: http://git-scm.com/figures/18333fig0332-tn.png
  [6]: http://git-scm.com/figures/18333fig0333-tn.png
  [7]: http://git-scm.com/figures/18333fig0334-tn.png
  [8]: http://git-scm.com/figures/18333fig0501-tn.png
  [9]: http://git-scm.com/figures/18333fig0502-tn.png
  [10]: http://git-scm.com/figures/18333fig0503-tn.png
  [11]: http://git-scm.com/figures/18333fig0511-tn.png
  [12]: http://git-scm.com/figures/18333fig0515-tn.png

\- 完 -
