Title: 《深入Python3》笔记：闭包
Date: 2016-06-23 16:24:16
Category: 技术
Tags: 笔记, Python
Slug: 《深入Python3》笔记：闭包
Author: Lemon Tree

### **必包的概念**

如果在一个内部函数里，对在外部作用域（但不是在全局作用域）的变量进行引用，那么内部函数就被认为是闭包(closure)。

```python
>>>def addx(x):
>>>    def adder(y): return x + y
>>>    return adder

>>> c =  addx(8)
>>> type(c)
<type 'function'>
>>> c.__name__
'adder'
>>> c(10)
18
```

在函数addx()的中，内部函数adder()是闭包，因为它除了调用了自身的参数y以外，也引用了外部函数addx()的参数x。

### **使用闭包时的注意点**

##### 1. 闭包不能修改外部作用域的局部变量

```python
>>> def foo():
        m = 0

        def foo1():
            m = 1
            print m

        print m
        foo1()
        print m

>>> foo()
0
1
0
```

##### 2. 一种典型的错误

错误的用法：

```python
def foo():
    a = 1
    def bar():
        a = a + 1   # a被解析为bar中的局部变量，但是右侧的a会找不到值
        return a
    return bar
```

正确的用法：

```python
def foo():
    a = 1
    def bar():
        nonlocal a  #指明a不是bar()的局部变量，这样a就被解析为foo中的变量
        a = a + 1
        return a
    return bar
```

##### 3. python的函数只有在执行时，才会去找函数体里的变量的值

前提：当循环结束以后，循环体中的临时变量i不会销毁，而是继续存在于执行环境中。

```python
for i in range(3):
    print i
```

错误的用法：输出为4,4,4

```python
flist = []
for i in range(3):
    def foo(x): print x + i
    flist.append(foo)
for f in flist:                     #此时i的值为2
    f(2)                            #执行 print 2 + 2
```

正确的用法：输出为2,3,4

```python
flist = []
for i in range(3):
    def foo(x, y=i): print x + y
    flist.append(foo)               #被添加到flist的是foo(x, 0), foo(x, 1), foo(x, 2)
for f in flist:
    f(2)
```

### **必包的作用**

##### 1. 保持当前的运行环境

```python
origin = [0, 0]             # 坐标系统原点
legal_x = [0, 50]           # x轴方向的合法坐标
legal_y = [0, 50]           # y轴方向的合法坐标
def create(pos=origin):
    def player(direction,step):
        # 这里应该首先判断参数direction,step的合法性，比如direction不能斜着走，step不能为负等
        # 然后还要对新生成的x，y坐标的合法性进行判断处理，这里主要是想介绍闭包，就不详细写了。
        new_x = pos[0] + direction[0]*step
        new_y = pos[1] + direction[1]*step
        pos[0] = new_x
        pos[1] = new_y
        #注意！此处不能写成 pos = [new_x, new_y]，原因在上文有说过
        return pos
    return player

player = create()           # 创建棋子player，起点为原点
print player([1,0],10)      # 向x轴正方向移动10步
print player([0,1],20)      # 向y轴正方向移动20步
print player([-1,0],10)     # 向x轴负方向移动10步
```

输出为

```python
[10, 0]
[10, 20]
[0, 20]
```

##### 2. 根据外部作用域的局部变量来得到不同的结果，这有点像一种类似配置功能的作用，我们可以修改外部的变量，闭包根据这个变量展现出不同的功能

```python
def make_filter(keep):
    def the_filter(file_name):
        file = open(file_name)
        lines = file.readlines()
        file.close()
        filter_doc = [i for i in lines if keep in i]
        return filter_doc
    return the_filter
```

如果我们需要取得文件"result.txt"中含有"pass"关键字的行，则可以这样使用例子程序

```python
filter = make_filter("pass")
filter_result = filter("result.txt")
```

### **参考**

[Python中的闭包](http://blog.csdn.net/marty_fu/article/details/7679297)

\- 完 -
